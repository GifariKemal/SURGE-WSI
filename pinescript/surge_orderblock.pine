//@version=6
indicator("SURGE Order Block v2", shorttitle="S-OB", overlay=true, max_boxes_count=500, max_labels_count=500)

// ============================================================================
// SURGE-WSI Order Block Detector v2
// ============================================================================
// Pine Script v6 - untuk TradingView
// Match dengan poi_detector.py logic
// Author: SURIOTA Team
// ============================================================================

// ============================================================================
// INPUT SETTINGS
// ============================================================================
grp_ob = "Order Block Settings"
swing_length = input.int(10, "Swing Length", minval=3, maxval=50, group=grp_ob, tooltip="Bars for swing detection (same as Python: 10)")
impulsive_ratio = input.float(1.5, "Impulsive Ratio", minval=1.0, maxval=5.0, step=0.1, group=grp_ob, tooltip="Minimum ratio of impulse move to OB body (default: 1.5x)")
min_strength = input.float(0.4, "Min Strength", minval=0.1, maxval=1.0, step=0.1, group=grp_ob, tooltip="Minimum OB strength (0-1, same as Python: 0.4)")
max_ob_age = input.int(50, "Max OB Age (bars)", minval=10, maxval=200, group=grp_ob, tooltip="Order Block older than this will be removed (same as Python: 50)")
show_mitigated = input.bool(true, "Show Mitigated OB", group=grp_ob, tooltip="Show order blocks that have been mitigated")
extend_ob = input.bool(true, "Extend OB to Current Bar", group=grp_ob, tooltip="Extend OB box to current bar")
show_swing = input.bool(false, "Show Swing Points", group=grp_ob, tooltip="Show swing high/low markers")

// ============================================================================
// STYLE SETTINGS - Shadcn/UI Inspired Theme
// ============================================================================
grp_style = "Style Settings"

// Shadcn-style color palette (muted, sophisticated)
// Emerald for bullish (hsl 142 76% 36%)
// Rose for bearish (hsl 346 77% 50%)
BULL_PRIMARY = color.rgb(16, 185, 129)      // Emerald-500 #10b981
BULL_MUTED = color.rgb(5, 150, 105)         // Emerald-600 #059669
BEAR_PRIMARY = color.rgb(244, 63, 94)       // Rose-500 #f43f5e
BEAR_MUTED = color.rgb(225, 29, 72)         // Rose-600 #e11d48
ZINC_800 = color.rgb(39, 39, 42)            // Dark background #27272a
ZINC_700 = color.rgb(63, 63, 70)            // Lighter dark #3f3f46
ZINC_400 = color.rgb(161, 161, 170)         // Muted text #a1a1aa
ZINC_200 = color.rgb(228, 228, 231)         // Light text #e4e4e7

// User-adjustable colors with shadcn defaults
bull_ob_color = input.color(color.new(color.rgb(16, 185, 129), 85), "Bullish OB Fill", group=grp_style, tooltip="Emerald - shadcn style")
bear_ob_color = input.color(color.new(color.rgb(244, 63, 94), 85), "Bearish OB Fill", group=grp_style, tooltip="Rose - shadcn style")
bull_border_color = input.color(color.new(color.rgb(16, 185, 129), 40), "Bullish Border", group=grp_style)
bear_border_color = input.color(color.new(color.rgb(244, 63, 94), 40), "Bearish Border", group=grp_style)
mitigated_color = input.color(color.new(color.rgb(113, 113, 122), 90), "Mitigated OB Fill", group=grp_style, tooltip="Zinc-500 muted")
mitigated_border = color.new(color.rgb(113, 113, 122), 70)
show_labels = input.bool(true, "Show Labels", group=grp_style)
label_style = input.string("Minimal", "Label Style", options=["Minimal", "Detailed"], group=grp_style)

// ============================================================================
// SWING HIGH/LOW DETECTION (seperti Python swing_length=10)
// ============================================================================

// Detect swing high
is_swing_high(int idx) =>
    if idx < swing_length or idx > bar_index - swing_length
        false
    else
        highest_val = high[idx]
        is_highest = true
        for i = idx - swing_length to idx + swing_length
            offset = idx - i
            if offset != 0 and high[offset] > highest_val
                is_highest := false
                break
        is_highest

// Detect swing low
is_swing_low(int idx) =>
    if idx < swing_length or idx > bar_index - swing_length
        false
    else
        lowest_val = low[idx]
        is_lowest = true
        for i = idx - swing_length to idx + swing_length
            offset = idx - i
            if offset != 0 and low[offset] < lowest_val
                is_lowest := false
                break
        is_lowest

// ============================================================================
// ORDER BLOCK DETECTION LOGIC (sama dengan poi_detector.py fallback)
// ============================================================================

// Helper functions
is_down_candle(int idx) =>
    close[idx] < open[idx]

is_up_candle(int idx) =>
    close[idx] > open[idx]

get_body_size(int idx) =>
    math.abs(close[idx] - open[idx])

get_candle_range(int idx) =>
    high[idx] - low[idx]

// Calculate OB strength (0-1, normalized by size)
// Python: strength = min(1.0, size_pips / 20)
calc_ob_strength(float ob_top, float ob_bottom) =>
    pip_size = syminfo.mintick >= 0.01 ? 0.01 : 0.0001
    size_pips = math.abs(ob_top - ob_bottom) / pip_size
    math.min(1.0, size_pips / 20.0)

// ============================================================================
// PATTERN 1: Simple 3-candle pattern (original)
// Bullish OB: candle down di [2], diikuti impulsive up di [1] dan [0]
// ============================================================================
bullish_ob_pattern1() =>
    (is_down_candle(2) and
     is_up_candle(1) and
     close > close[1] and
     (close - open[2]) > (get_body_size(2) * impulsive_ratio))

bearish_ob_pattern1() =>
    (is_up_candle(2) and
     is_down_candle(1) and
     close < close[1] and
     (open[2] - close) > (get_body_size(2) * impulsive_ratio))

// ============================================================================
// PATTERN 2: Swing-based OB (seperti smartmoneyconcepts)
// OB formed at swing point with strong rejection
// ============================================================================

// Pre-calculate ta functions at global scope for consistent execution
swing_lowest = ta.lowest(low, swing_length * 2)
swing_highest = ta.highest(high, swing_length * 2)

bullish_ob_pattern2() =>
    // Down candle at recent swing low followed by reversal
    (is_down_candle(3) and
     low[3] <= swing_lowest and
     is_up_candle(2) and
     is_up_candle(1) and
     (close - low[3]) > (get_candle_range(3) * impulsive_ratio))

bearish_ob_pattern2() =>
    // Up candle at recent swing high followed by reversal
    (is_up_candle(3) and
     high[3] >= swing_highest and
     is_down_candle(2) and
     is_down_candle(1) and
     (high[3] - close) > (get_candle_range(3) * impulsive_ratio))

// ============================================================================
// PATTERN 3: Engulfing OB pattern
// Strong engulfing candle creates OB zone
// ============================================================================
bullish_ob_pattern3() =>
    // Bearish candle followed by bullish engulfing
    (is_down_candle(2) and
     is_up_candle(1) and
     open[1] <= close[2] and
     close[1] >= open[2] and
     get_body_size(1) > get_body_size(2) * 1.2)

bearish_ob_pattern3() =>
    // Bullish candle followed by bearish engulfing
    (is_up_candle(2) and
     is_down_candle(1) and
     open[1] >= close[2] and
     close[1] <= open[2] and
     get_body_size(1) > get_body_size(2) * 1.2)

// ============================================================================
// COMBINED DETECTION - Call all patterns at global scope for consistency
// ============================================================================

// Call all pattern functions on every bar (Pine Script requirement)
_bull_pattern1 = bullish_ob_pattern1()
_bull_pattern2 = bullish_ob_pattern2()
_bull_pattern3 = bullish_ob_pattern3()
_bear_pattern1 = bearish_ob_pattern1()
_bear_pattern2 = bearish_ob_pattern2()
_bear_pattern3 = bearish_ob_pattern3()

// Combined detection using pre-calculated values
bullish_ob_detected = _bull_pattern1 or _bull_pattern2 or _bull_pattern3
bearish_ob_detected = _bear_pattern1 or _bear_pattern2 or _bear_pattern3

// Calculate OB zones at global scope for all patterns
// Bull zones: [top, bottom, offset]
_bull_zone1_top = open[2]
_bull_zone1_bottom = low[2]
_bull_zone2_top = open[3]
_bull_zone2_bottom = low[3]

// Bear zones: [top, bottom, offset]
_bear_zone1_top = high[2]
_bear_zone1_bottom = open[2]
_bear_zone2_top = high[3]
_bear_zone2_bottom = open[3]

// Get OB zone based on which pattern triggered (using pre-calculated values)
get_bull_ob_zone() =>
    if _bull_pattern1
        [_bull_zone1_top, _bull_zone1_bottom, 2]
    else if _bull_pattern2
        [_bull_zone2_top, _bull_zone2_bottom, 3]
    else if _bull_pattern3
        [_bull_zone1_top, _bull_zone1_bottom, 2]
    else
        [_bull_zone1_top, _bull_zone1_bottom, 2]

get_bear_ob_zone() =>
    if _bear_pattern1
        [_bear_zone1_top, _bear_zone1_bottom, 2]
    else if _bear_pattern2
        [_bear_zone2_top, _bear_zone2_bottom, 3]
    else if _bear_pattern3
        [_bear_zone1_top, _bear_zone1_bottom, 2]
    else
        [_bear_zone1_top, _bear_zone1_bottom, 2]

// ============================================================================
// ORDER BLOCK STORAGE & MANAGEMENT
// ============================================================================

// Arrays to store OB data
var box[] bull_ob_boxes = array.new_box()
var box[] bear_ob_boxes = array.new_box()
var float[] bull_ob_tops = array.new_float()
var float[] bull_ob_bottoms = array.new_float()
var float[] bear_ob_tops = array.new_float()
var float[] bear_ob_bottoms = array.new_float()
var int[] bull_ob_bars = array.new_int()
var int[] bear_ob_bars = array.new_int()
var bool[] bull_ob_mitigated = array.new_bool()
var bool[] bear_ob_mitigated = array.new_bool()
var float[] bull_ob_strengths = array.new_float()
var float[] bear_ob_strengths = array.new_float()

// ============================================================================
// CREATE NEW ORDER BLOCKS
// ============================================================================

// Pre-calculate zone values at global scope for consistent execution
[_bull_ob_top, _bull_ob_bottom, _bull_ob_offset] = get_bull_ob_zone()
[_bear_ob_top, _bear_ob_bottom, _bear_ob_offset] = get_bear_ob_zone()
_bull_ob_bar = bar_index - _bull_ob_offset
_bear_ob_bar = bar_index - _bear_ob_offset
_bull_strength = calc_ob_strength(_bull_ob_top, _bull_ob_bottom)
_bear_strength = calc_ob_strength(_bear_ob_top, _bear_ob_bottom)

// Detect and create Bullish OB
if bullish_ob_detected
    // Only create if strength meets minimum (same as Python)
    if _bull_strength >= min_strength
        // Create box with shadcn-style subtle appearance
        new_box = box.new(
            left=_bull_ob_bar,
            top=_bull_ob_top,
            right=extend_ob ? bar_index + 10 : _bull_ob_bar + max_ob_age,
            bottom=_bull_ob_bottom,
            bgcolor=bull_ob_color,
            border_color=bull_border_color,
            border_width=1,
            border_style=line.style_solid)

        // Store data
        array.push(bull_ob_boxes, new_box)
        array.push(bull_ob_tops, _bull_ob_top)
        array.push(bull_ob_bottoms, _bull_ob_bottom)
        array.push(bull_ob_bars, _bull_ob_bar)
        array.push(bull_ob_mitigated, false)
        array.push(bull_ob_strengths, _bull_strength)

        // Add label - shadcn minimal style
        if show_labels
            label_text = label_style == "Minimal" ? "▲ " + str.tostring(_bull_strength * 100, "#") + "%" : "OB ▲ " + str.tostring(_bull_strength * 100, "#.#") + "%"
            label.new(x=_bull_ob_bar, y=_bull_ob_bottom, text=label_text, style=label.style_label_up, color=color.new(ZINC_800, 20), textcolor=BULL_PRIMARY, size=size.tiny)

// Detect and create Bearish OB
if bearish_ob_detected
    // Only create if strength meets minimum
    if _bear_strength >= min_strength
        // Create box with shadcn-style subtle appearance
        new_box = box.new(
            left=_bear_ob_bar,
            top=_bear_ob_top,
            right=extend_ob ? bar_index + 10 : _bear_ob_bar + max_ob_age,
            bottom=_bear_ob_bottom,
            bgcolor=bear_ob_color,
            border_color=bear_border_color,
            border_width=1,
            border_style=line.style_solid)

        // Store data
        array.push(bear_ob_boxes, new_box)
        array.push(bear_ob_tops, _bear_ob_top)
        array.push(bear_ob_bottoms, _bear_ob_bottom)
        array.push(bear_ob_bars, _bear_ob_bar)
        array.push(bear_ob_mitigated, false)
        array.push(bear_ob_strengths, _bear_strength)

        // Add label - shadcn minimal style
        if show_labels
            label_text = label_style == "Minimal" ? "▼ " + str.tostring(_bear_strength * 100, "#") + "%" : "OB ▼ " + str.tostring(_bear_strength * 100, "#.#") + "%"
            label.new(x=_bear_ob_bar, y=_bear_ob_top, text=label_text, style=label.style_label_down, color=color.new(ZINC_800, 20), textcolor=BEAR_PRIMARY, size=size.tiny)

// ============================================================================
// UPDATE ORDER BLOCKS (Extend & Check Mitigation)
// Same logic as Python poi_detector.py lines 697-706
// ============================================================================

// Update Bullish OBs
if array.size(bull_ob_boxes) > 0
    for i = array.size(bull_ob_boxes) - 1 to 0
        ob_box = array.get(bull_ob_boxes, i)
        ob_top = array.get(bull_ob_tops, i)
        ob_bottom = array.get(bull_ob_bottoms, i)
        ob_bar = array.get(bull_ob_bars, i)
        is_mitigated = array.get(bull_ob_mitigated, i)

        // Check age - remove if too old
        if bar_index - ob_bar > max_ob_age
            box.delete(ob_box)
            array.remove(bull_ob_boxes, i)
            array.remove(bull_ob_tops, i)
            array.remove(bull_ob_bottoms, i)
            array.remove(bull_ob_bars, i)
            array.remove(bull_ob_mitigated, i)
            array.remove(bull_ob_strengths, i)
            continue

        // Check mitigation (Python: current_price < ob.bottom)
        // Bullish OB mitigated if price goes BELOW the zone
        if not is_mitigated and low < ob_bottom
            array.set(bull_ob_mitigated, i, true)
            if show_mitigated
                box.set_bgcolor(ob_box, mitigated_color)
                box.set_border_color(ob_box, mitigated_border)
                box.set_border_style(ob_box, line.style_dashed)
            else
                box.delete(ob_box)
                array.remove(bull_ob_boxes, i)
                array.remove(bull_ob_tops, i)
                array.remove(bull_ob_bottoms, i)
                array.remove(bull_ob_bars, i)
                array.remove(bull_ob_mitigated, i)
                array.remove(bull_ob_strengths, i)
                continue

        // Extend box to current bar
        if extend_ob and not array.get(bull_ob_mitigated, i)
            box.set_right(ob_box, bar_index + 10)

// Update Bearish OBs
if array.size(bear_ob_boxes) > 0
    for i = array.size(bear_ob_boxes) - 1 to 0
        ob_box = array.get(bear_ob_boxes, i)
        ob_top = array.get(bear_ob_tops, i)
        ob_bottom = array.get(bear_ob_bottoms, i)
        ob_bar = array.get(bear_ob_bars, i)
        is_mitigated = array.get(bear_ob_mitigated, i)

        // Check age - remove if too old
        if bar_index - ob_bar > max_ob_age
            box.delete(ob_box)
            array.remove(bear_ob_boxes, i)
            array.remove(bear_ob_tops, i)
            array.remove(bear_ob_bottoms, i)
            array.remove(bear_ob_bars, i)
            array.remove(bear_ob_mitigated, i)
            array.remove(bear_ob_strengths, i)
            continue

        // Check mitigation (Python: current_price > ob.top)
        // Bearish OB mitigated if price goes ABOVE the zone
        if not is_mitigated and high > ob_top
            array.set(bear_ob_mitigated, i, true)
            if show_mitigated
                box.set_bgcolor(ob_box, mitigated_color)
                box.set_border_color(ob_box, mitigated_border)
                box.set_border_style(ob_box, line.style_dashed)
            else
                box.delete(ob_box)
                array.remove(bear_ob_boxes, i)
                array.remove(bear_ob_tops, i)
                array.remove(bear_ob_bottoms, i)
                array.remove(bear_ob_bars, i)
                array.remove(bear_ob_mitigated, i)
                array.remove(bear_ob_strengths, i)
                continue

        // Extend box to current bar
        if extend_ob and not array.get(bear_ob_mitigated, i)
            box.set_right(ob_box, bar_index + 10)

// ============================================================================
// SWING POINT VISUALIZATION (optional) - Shadcn muted style
// ============================================================================
plotshape(show_swing and is_swing_high(swing_length) ? high[swing_length] : na,
          title="Swing High", location=location.abovebar,
          style=shape.xcross, size=size.tiny, color=ZINC_400, offset=-swing_length)
plotshape(show_swing and is_swing_low(swing_length) ? low[swing_length] : na,
          title="Swing Low", location=location.belowbar,
          style=shape.xcross, size=size.tiny, color=ZINC_400, offset=-swing_length)

// ============================================================================
// ALERTS
// ============================================================================

// Alert when price enters active Bullish OB (potential BUY zone)
price_in_bull_ob = false
if array.size(bull_ob_boxes) > 0
    for i = 0 to array.size(bull_ob_boxes) - 1
        if not array.get(bull_ob_mitigated, i)
            ob_top = array.get(bull_ob_tops, i)
            ob_bottom = array.get(bull_ob_bottoms, i)
            if low <= ob_top and high >= ob_bottom
                price_in_bull_ob := true
                break

// Alert when price enters active Bearish OB (potential SELL zone)
price_in_bear_ob = false
if array.size(bear_ob_boxes) > 0
    for i = 0 to array.size(bear_ob_boxes) - 1
        if not array.get(bear_ob_mitigated, i)
            ob_top = array.get(bear_ob_tops, i)
            ob_bottom = array.get(bear_ob_bottoms, i)
            if low <= ob_top and high >= ob_bottom
                price_in_bear_ob := true
                break

alertcondition(price_in_bull_ob, title="Price at Bullish OB", message="SURGE-WSI: Price entered Bullish Order Block - Potential BUY zone")
alertcondition(price_in_bear_ob, title="Price at Bearish OB", message="SURGE-WSI: Price entered Bearish Order Block - Potential SELL zone")
alertcondition(bullish_ob_detected, title="New Bullish OB", message="SURGE-WSI: New Bullish Order Block detected")
alertcondition(bearish_ob_detected, title="New Bearish OB", message="SURGE-WSI: New Bearish Order Block detected")

// ============================================================================
// INFO TABLE - Shadcn/UI Card Style
// ============================================================================

// Shadcn-style card: dark background, subtle border, clean typography
var table info_table = table.new(
    position.top_right, 2, 5,
    bgcolor=color.new(ZINC_800, 5),
    frame_color=color.new(ZINC_700, 30),
    frame_width=1,
    border_color=color.new(ZINC_700, 60),
    border_width=1)

if barstate.islast
    active_bull_count = 0
    active_bear_count = 0
    avg_bull_strength = 0.0
    avg_bear_strength = 0.0

    // Check array size > 0 before looping to avoid out of bounds
    if array.size(bull_ob_mitigated) > 0
        for i = 0 to array.size(bull_ob_mitigated) - 1
            if not array.get(bull_ob_mitigated, i)
                active_bull_count += 1
                avg_bull_strength += array.get(bull_ob_strengths, i)

    if array.size(bear_ob_mitigated) > 0
        for i = 0 to array.size(bear_ob_mitigated) - 1
            if not array.get(bear_ob_mitigated, i)
                active_bear_count += 1
                avg_bear_strength += array.get(bear_ob_strengths, i)

    if active_bull_count > 0
        avg_bull_strength := avg_bull_strength / active_bull_count
    if active_bear_count > 0
        avg_bear_strength := avg_bear_strength / active_bear_count

    // Header row - clean title
    table.cell(info_table, 0, 0, "SURGE", text_color=ZINC_200, text_size=size.small, text_halign=text.align_left)
    table.cell(info_table, 1, 0, "OB", text_color=ZINC_400, text_size=size.small, text_halign=text.align_right)

    // Bull stats with badge style
    table.cell(info_table, 0, 1, "▲ Bullish", text_color=BULL_PRIMARY, text_size=size.tiny, text_halign=text.align_left)
    table.cell(info_table, 1, 1, str.tostring(active_bull_count) + "  " + str.tostring(avg_bull_strength * 100, "#") + "%", text_color=BULL_MUTED, text_size=size.tiny, text_halign=text.align_right)

    // Bear stats with badge style
    table.cell(info_table, 0, 2, "▼ Bearish", text_color=BEAR_PRIMARY, text_size=size.tiny, text_halign=text.align_left)
    table.cell(info_table, 1, 2, str.tostring(active_bear_count) + "  " + str.tostring(avg_bear_strength * 100, "#") + "%", text_color=BEAR_MUTED, text_size=size.tiny, text_halign=text.align_right)

    // Settings info - muted
    table.cell(info_table, 0, 3, "Swing", text_color=ZINC_400, text_size=size.tiny, text_halign=text.align_left)
    table.cell(info_table, 1, 3, str.tostring(swing_length), text_color=ZINC_400, text_size=size.tiny, text_halign=text.align_right)

    table.cell(info_table, 0, 4, "Min %", text_color=ZINC_400, text_size=size.tiny, text_halign=text.align_left)
    table.cell(info_table, 1, 4, str.tostring(min_strength * 100, "#") + "%", text_color=ZINC_400, text_size=size.tiny, text_halign=text.align_right)

// ============================================================================
// PLOT SIGNALS - Shadcn style markers
// ============================================================================

plotshape(bullish_ob_detected, title="Bullish OB Signal", location=location.belowbar, style=shape.diamond, size=size.tiny, color=BULL_PRIMARY)
plotshape(bearish_ob_detected, title="Bearish OB Signal", location=location.abovebar, style=shape.diamond, size=size.tiny, color=BEAR_PRIMARY)
